{%- comment -%}
  Videos Gallery - Display video entries with YouTube/Vimeo thumbnails
  Uses data from _data/videos.yml
  Features in-site modal player for YouTube videos
{%- endcomment -%}

{%- assign all_videos = site.data.videos.videos -%}
{%- assign grouped_videos = all_videos | group_by: "category" -%}

<div class="videos-wrapper">
  <div class="container-md py-4">

    {%- for group in grouped_videos -%}
    <section class="videos-section fade-in mb-5">
      
      <!-- Section Label -->
      <div class="section-label">
        <div class="section-label__icon">
          <i class="fas fa-video"></i>
        </div>
        <span class="section-label__text">
          {%- if group.name != blank -%}
            {{ group.name }}
          {%- else -%}
            Videos
          {%- endif -%}
        </span>
      </div>

      <!-- Videos Grid -->
      <div class="videos-grid">
        {%- for video in group.items -%}
        
        {%- comment -%} Extract YouTube video ID for thumbnail and embed {%- endcomment -%}
        {%- assign video_id = "" -%}
        {%- assign thumbnail_url = video.thumbnail -%}
        
        {%- if video.url contains "youtube.com/watch" -%}
          {%- assign video_id = video.url | split: "v=" | last | split: "&" | first -%}
        {%- elsif video.url contains "youtu.be/" -%}
          {%- assign video_id = video.url | split: "youtu.be/" | last | split: "?" | first -%}
        {%- elsif video.url contains "youtube.com/embed/" -%}
          {%- assign video_id = video.url | split: "embed/" | last | split: "?" | first -%}
        {%- endif -%}
        
        {%- if thumbnail_url == blank and video_id != "" -%}
          {%- assign thumbnail_url = "https://img.youtube.com/vi/" | append: video_id | append: "/maxresdefault.jpg" -%}
        {%- endif -%}

        <div class="video-card minimal-card minimal-card--interactive" 
             data-video-id="{{ video_id }}" 
             data-video-url="{{ video.url }}"
             data-video-title="{{ video.title }}"
             onclick="openVideoModal('{{ video_id }}', '{{ video.title | escape }}')">
          
          <!-- Video Thumbnail -->
          <div class="video-card__thumbnail">
            {%- if thumbnail_url != blank -%}
              <img src="{{ thumbnail_url }}" alt="{{ video.title }}" loading="lazy" onerror="this.src='https://img.youtube.com/vi/{{ video_id }}/hqdefault.jpg'">
            {%- else -%}
              <div class="video-card__placeholder">
                <i class="fas fa-film"></i>
              </div>
            {%- endif -%}
            <div class="video-card__play-overlay">
              <i class="fas fa-play-circle"></i>
            </div>
          </div>
          
          <!-- Video Info -->
          <div class="video-card__content">
            <h3 class="video-card__title t-title">{{ video.title }}</h3>
            
            {%- if video.speaker != blank -%}
            <div class="video-card__speaker">
              <i class="fas fa-user"></i>
              <span>{{ video.speaker }}</span>
            </div>
            {%- endif -%}
            
            {%- if video.description != blank -%}
            <p class="video-card__desc t-body">{{ video.description | truncate: 120 }}</p>
            {%- endif -%}
            
            {%- if video.date != blank -%}
            <div class="video-card__meta">
              <i class="fas fa-calendar-alt"></i>
              <span>{{ video.date | date: "%B %d, %Y" }}</span>
            </div>
            {%- endif -%}
          </div>
          
        </div>

        {%- endfor -%}
      </div>

    </section>
    {%- endfor -%}

    {% if all_videos.size == 0 or all_videos == nil %}
      <div class="text-center py-5">
        <div class="alert alert-secondary">
          <i class="fas fa-video-slash fa-2x mb-3"></i>
          <h4>No videos yet</h4>
          <p>Check back soon for research talks, tutorials, and lab activity recordings!</p>
        </div>
      </div>
    {% endif %}

  </div>
</div>

<!-- Video Modal -->
<div class="video-modal" id="videoModal" onclick="closeVideoModal(event)">
  <div class="video-modal__container">
    <button class="video-modal__close" onclick="closeVideoModal(event)" aria-label="Close video">
      <i class="fas fa-times"></i>
    </button>
    <div class="video-modal__content">
      <div class="video-modal__player" id="videoPlayer">
        <!-- YouTube iframe will be inserted here -->
      </div>
    </div>
    <div class="video-modal__title" id="videoModalTitle"></div>
  </div>
</div>

<style>
/* Videos Grid Layout */
.videos-wrapper {
  min-height: 60vh;
}

.videos-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 1.5rem;
  margin-top: 1.5rem;
}

/* Video Card */
.video-card {
  display: flex;
  flex-direction: column;
  background: var(--global-card-bg-color);
  border-radius: 12px;
  overflow: hidden;
  text-decoration: none;
  color: inherit;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  cursor: pointer;
}

.video-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.12);
  text-decoration: none;
  color: inherit;
}

/* Thumbnail */
.video-card__thumbnail {
  position: relative;
  width: 100%;
  padding-top: 56.25%; /* 16:9 aspect ratio */
  overflow: hidden;
  background: var(--global-divider-color);
}

.video-card__thumbnail img {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.video-card:hover .video-card__thumbnail img {
  transform: scale(1.05);
}

.video-card__placeholder {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, var(--global-theme-color) 0%, var(--global-hover-color) 100%);
  color: white;
  font-size: 3rem;
}

/* Play Button Overlay */
.video-card__play-overlay {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 4rem;
  color: rgba(255, 255, 255, 0.9);
  text-shadow: 0 2px 10px rgba(0,0,0,0.3);
  opacity: 0.85;
  transition: opacity 0.3s ease, transform 0.3s ease;
}

.video-card:hover .video-card__play-overlay {
  opacity: 1;
  transform: translate(-50%, -50%) scale(1.1);
}

/* Content */
.video-card__content {
  padding: 1rem 1.25rem 1.25rem;
  flex: 1;
  display: flex;
  flex-direction: column;
}

.video-card__title {
  font-size: 1.1rem;
  font-weight: 600;
  margin: 0 0 0.5rem 0;
  line-height: 1.3;
}

.video-card__desc {
  font-size: 0.9rem;
  color: var(--global-text-color-light);
  margin: 0 0 0.75rem 0;
  flex: 1;
}

.video-card__meta {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.85rem;
  color: var(--global-text-color-light);
}

.video-card__meta i {
  font-size: 0.8rem;
  opacity: 0.7;
}

.video-card__speaker {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
  color: var(--global-theme-color);
  margin-bottom: 0.5rem;
}

.video-card__speaker i {
  font-size: 0.8rem;
}

/* Section Label */
.videos-section .section-label {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 1rem;
}

.videos-section .section-label__icon {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  background: var(--global-theme-color);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1rem;
}

.videos-section .section-label__text {
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--global-theme-color);
}

/* Video Modal */
.video-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.9);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: 9999;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 2rem;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.video-modal.active {
  display: flex;
  opacity: 1;
}

.video-modal__container {
  position: relative;
  width: 100%;
  max-width: 1000px;
}

.video-modal__close {
  position: absolute;
  top: -40px;
  right: 0;
  background: transparent;
  border: none;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0.5rem;
  opacity: 0.8;
  transition: opacity 0.2s, transform 0.2s;
  z-index: 10;
}

.video-modal__close:hover {
  opacity: 1;
  transform: scale(1.1);
}

.video-modal__content {
  background: #000;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.video-modal__player {
  position: relative;
  width: 100%;
  padding-top: 56.25%; /* 16:9 aspect ratio */
}

.video-modal__player iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: none;
}

.video-modal__title {
  color: white;
  text-align: center;
  padding: 1rem;
  font-size: 1.1rem;
  font-weight: 500;
}

/* Responsive */
@media (max-width: 768px) {
  .videos-grid {
    grid-template-columns: 1fr;
  }
  
  .video-modal {
    padding: 1rem;
  }
  
  .video-modal__close {
    top: -35px;
    right: 0;
  }
}
</style>

<script>
function openVideoModal(videoId, title) {
  if (!videoId) {
    // If no video ID (not a YouTube video), open in new tab
    const card = event.currentTarget;
    const url = card.dataset.videoUrl;
    if (url) window.open(url, '_blank');
    return;
  }
  
  const modal = document.getElementById('videoModal');
  const player = document.getElementById('videoPlayer');
  const titleEl = document.getElementById('videoModalTitle');
  
  // Create YouTube embed iframe with autoplay
  player.innerHTML = `<iframe 
    src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0" 
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
    allowfullscreen>
  </iframe>`;
  
  titleEl.textContent = title;
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeVideoModal(event) {
  // Only close if clicking on modal background or close button
  if (event.target.classList.contains('video-modal') || 
      event.target.closest('.video-modal__close')) {
    const modal = document.getElementById('videoModal');
    const player = document.getElementById('videoPlayer');
    
    modal.classList.remove('active');
    player.innerHTML = ''; // Stop video
    document.body.style.overflow = '';
  }
}

// Close on ESC key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const modal = document.getElementById('videoModal');
    if (modal.classList.contains('active')) {
      modal.classList.remove('active');
      document.getElementById('videoPlayer').innerHTML = '';
      document.body.style.overflow = '';
    }
  }
});
</script>
